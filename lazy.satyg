@import: lazy0
@import: ref

let make-promise v =
  Promise (Ref.make (Ref.make (Value v)))

let-rec force (Promise p) =
  match p |> Ref.get |> Ref.get with
  | Value v -> v
  | Thunk f ->
    let (Promise q) = f () in
    match p |> Ref.get |> Ref.get with % p may be updated during evaluation of q
    | Value v -> v
    | _ ->
      let () = Ref.get p |> Ref.set (Ref.get (Ref.get q)) in
      let () = q |> Ref.set (Ref.get p) in
      force (Promise p)