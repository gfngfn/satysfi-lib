@stage: 0
@import: base0

type 'a promise = Promise of (('a (unit -> 'a promise) either) ref) ref

%let delay-force e = &(Promise (Ref.make (Ref.make (Right (fun () -> ~e)))))
let delay-force e = &(Promise (let-mutable r <- (let-mutable r <- (Right (fun () -> ~e)) in r) in r))

%let delay e = delay-force &(Promise (Ref.make (Ref.make (Left (~e)))))
let delay e = delay-force &(Promise (let-mutable r <- (let-mutable r <- (Left (~e)) in r) in r))
